name: ğŸš€ Build æ—¶å…‰å¤‡å¿˜å½• APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
        - release
        - debug

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: â˜• Setup Java JDK
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: ğŸ¤– Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: ğŸ“¦ Install Global Dependencies
      run: |
        npm install -g cordova@latest
        cordova telemetry off
        
    - name: ğŸ“‹ Install Project Dependencies
      run: |
        if [ -f package.json ]; then
          npm install
        else
          echo "No package.json found, skipping npm install"
        fi
        
    - name: ğŸ”§ Prepare Cordova Project
      run: |
        # å¦‚æœä¸æ˜¯Cordovaé¡¹ç›®ï¼Œåˆ›å»ºä¸€ä¸ª
        if [ ! -f config.xml ]; then
          cordova create temp-app com.timekeeper.memo "æ—¶å…‰å¤‡å¿˜å½•"
          cp -r build-package/* temp-app/www/
          cp build-package/config.xml temp-app/
          cd temp-app
        fi
        
        # æ·»åŠ Androidå¹³å°
        cordova platform add android@latest
        
    - name: ğŸ”Œ Install Cordova Plugins
      run: |
        cordova plugin add cordova-plugin-whitelist
        cordova plugin add cordova-plugin-statusbar
        cordova plugin add cordova-plugin-device
        cordova plugin add cordova-plugin-splashscreen
        cordova plugin add cordova-plugin-vibration
        
    - name: ğŸ—ï¸ Build APK
      run: |
        BUILD_TYPE="${{ github.event.inputs.build_type || 'release' }}"
        echo "Building $BUILD_TYPE APK..."
        
        if [ "$BUILD_TYPE" = "release" ]; then
          cordova build android --release
          APK_PATH="platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk"
        else
          cordova build android --debug
          APK_PATH="platforms/android/app/build/outputs/apk/debug/app-debug.apk"
        fi
        
        # æ£€æŸ¥APKæ˜¯å¦ç”ŸæˆæˆåŠŸ
        if [ -f "$APK_PATH" ]; then
          echo "âœ… APK built successfully: $APK_PATH"
          ls -la "$APK_PATH"
        else
          echo "âŒ APK build failed"
          exit 1
        fi
        
    - name: ğŸ“± Rename APK
      run: |
        BUILD_TYPE="${{ github.event.inputs.build_type || 'release' }}"
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        
        if [ "$BUILD_TYPE" = "release" ]; then
          cp platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk \
             "æ—¶å…‰å¤‡å¿˜å½•-v1.0.0-${TIMESTAMP}-release.apk"
        else
          cp platforms/android/app/build/outputs/apk/debug/app-debug.apk \
             "æ—¶å…‰å¤‡å¿˜å½•-v1.0.0-${TIMESTAMP}-debug.apk"
        fi
        
    - name: ğŸ“¤ Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: timekeeper-memo-apk-${{ github.event.inputs.build_type || 'release' }}
        path: |
          æ—¶å…‰å¤‡å¿˜å½•-v1.0.0-*-*.apk
        retention-days: 30
        
    - name: ğŸ“Š Build Summary
      run: |
        echo "## ğŸ‰ æ„å»ºå®Œæˆ!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“± åº”ç”¨ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **åº”ç”¨åç§°**: æ—¶å…‰å¤‡å¿˜å½•" >> $GITHUB_STEP_SUMMARY
        echo "- **ç‰ˆæœ¬**: 1.0.0" >> $GITHUB_STEP_SUMMARY
        echo "- **æ„å»ºç±»å‹**: ${{ github.event.inputs.build_type || 'release' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¦ ä¸‹è½½APK" >> $GITHUB_STEP_SUMMARY
        echo "1. ç‚¹å‡»ä¸Šæ–¹çš„ **Artifacts** éƒ¨åˆ†" >> $GITHUB_STEP_SUMMARY
        echo "2. ä¸‹è½½ \`timekeeper-memo-apk-${{ github.event.inputs.build_type || 'release' }}\`" >> $GITHUB_STEP_SUMMARY
        echo "3. è§£å‹è·å¾—APKæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ¨ åº”ç”¨åŠŸèƒ½" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å¤‡å¿˜å½•ç®¡ç†" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æ™ºèƒ½é—¹é’Ÿæé†’" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ä¼˜å…ˆçº§æ ‡è®°" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… é‡å¤æé†’" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æ—¥å†è§†å›¾" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æœç´¢ç­›é€‰" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æ·±è‰²æ¨¡å¼" >> $GITHUB_STEP_SUMMARY

  # å¯é€‰ï¼šæ„å»ºå¤šä¸ªç‰ˆæœ¬
  build-variants:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        build-type: [debug, release]
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: â˜• Setup Java JDK
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: ğŸ¤– Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: ğŸ“¦ Install Dependencies
      run: |
        npm install -g cordova@latest
        cordova telemetry off
        
    - name: ğŸ—ï¸ Build ${{ matrix.build-type }} APK
      run: |
        # å‡†å¤‡é¡¹ç›®
        if [ ! -f config.xml ]; then
          cordova create temp-app com.timekeeper.memo "æ—¶å…‰å¤‡å¿˜å½•"
          cp -r build-package/* temp-app/www/
          cp build-package/config.xml temp-app/
          cd temp-app
        fi
        
        # æ·»åŠ å¹³å°å’Œæ’ä»¶
        cordova platform add android@latest
        cordova plugin add cordova-plugin-whitelist cordova-plugin-statusbar cordova-plugin-device cordova-plugin-splashscreen cordova-plugin-vibration
        
        # æ„å»º
        cordova build android --${{ matrix.build-type }}
        
    - name: ğŸ“¤ Upload ${{ matrix.build-type }} APK
      uses: actions/upload-artifact@v4
      with:
        name: timekeeper-memo-${{ matrix.build-type }}-apk
        path: platforms/android/app/build/outputs/apk/${{ matrix.build-type }}/*.apk
